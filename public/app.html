<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>YFX0060 Õppija</title>
        <script src="https://cdn.tailwindcss.com"></script>
    </head>
    <body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
        <div class="container mx-auto px-4 py-8">
            <div class="max-w-3xl mx-auto">
                <!-- Header -->
                <div class="flex justify-between items-center mb-8">
                    <h1 class="text-3xl font-bold text-gray-800">
                        ⚛️ YFX0060 Õppija ⚛️
                    </h1>
                    <a
                        href="/"
                        class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition duration-200"
                    >
                        Tagasi
                    </a>
                </div>

                <!-- Progress Bar -->
                <div class="bg-white rounded-lg shadow-md p-4 mb-6">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm font-medium text-gray-600">
                            Küsimused
                        </span>
                        <span
                            class="text-sm font-medium text-gray-600"
                            id="progress-text"
                            >0/0</span
                        >
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-3">
                        <div
                            id="progress-bar"
                            class="bg-blue-500 h-3 rounded-full transition-all duration-300"
                            style="width: 0%"
                        ></div>
                    </div>
                </div>

                <!-- Flashcard -->
                <div class="bg-white rounded-2xl shadow-xl p-8 mb-6">
                    <div class="mb-6">
                        <h2 class="text-xl font-semibold text-gray-700 mb-4">
                            Küsimus:
                        </h2>
                        <p
                            id="question"
                            class="text-2xl text-gray-800 mb-6"
                        ></p>
                    </div>

                    <div class="mb-6">
                        <label
                            for="answer"
                            class="block text-lg font-semibold text-gray-700 mb-2"
                            >Sinu vastus:</label
                        >
                        <textarea
                            id="answer"
                            rows="4"
                            class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 transition duration-200"
                            placeholder="Type your answer here..."
                        ></textarea>
                    </div>

                    <button
                        id="submit-btn"
                        onclick="submitAnswer()"
                        class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg transition duration-200 transform hover:scale-105 shadow-md"
                    >
                        Esita vastus
                    </button>

                    <!-- Feedback -->
                    <div id="feedback" class="mt-6 hidden"></div>
                </div>

                <!-- Navigation -->
                <div class="flex gap-4">
                    <button
                        id="prev-btn"
                        onclick="previousCard()"
                        class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                        ← Eelmine
                    </button>
                    <button
                        id="next-btn"
                        onclick="nextCard()"
                        class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                        Järgmine →
                    </button>
                </div>
            </div>
        </div>

        <script>
            let flashcards = [];
            let currentIndex = 0;
            let userAnswers = [];

            function init() {
                const stored = localStorage.getItem("flashcards");
                const storedIndex = localStorage.getItem("currentIndex");

                if (!stored) {
                    window.location.href = "/";
                    return;
                }

                flashcards = JSON.parse(stored);
                currentIndex = parseInt(storedIndex || "0");
                userAnswers = new Array(flashcards.length).fill(null);

                displayCard();
            }

            function displayCard() {
                if (flashcards.length === 0) return;

                const card = flashcards[currentIndex];
                document.getElementById("question").textContent = card.question;
                document.getElementById("answer").value =
                    userAnswers[currentIndex]?.answer || "";
                document.getElementById("progress-text").textContent =
                    `${currentIndex + 1}/${flashcards.length}`;

                const progress = ((currentIndex + 1) / flashcards.length) * 100;
                document.getElementById("progress-bar").style.width =
                    `${progress}%`;

                document.getElementById("prev-btn").disabled =
                    currentIndex === 0;
                document.getElementById("next-btn").disabled =
                    currentIndex === flashcards.length - 1;

                const feedback = document.getElementById("feedback");
                if (userAnswers[currentIndex]) {
                    displayFeedback(userAnswers[currentIndex]);
                } else {
                    feedback.classList.add("hidden");
                }

                localStorage.setItem("currentIndex", currentIndex.toString());
            }

            async function submitAnswer() {
                const answerText = document
                    .getElementById("answer")
                    .value.trim();

                if (!answerText) {
                    alert("Please enter an answer!");
                    return;
                }

                const card = flashcards[currentIndex];

                try {
                    const response = await fetch("/api/check-answer", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            cardId: card.id,
                            answer: answerText,
                        }),
                    });

                    const result = await response.json();
                    userAnswers[currentIndex] = {
                        answer: answerText,
                        isCorrect: result.isCorrect,
                        correctAnswer: result.correctAnswer,
                    };

                    displayFeedback(userAnswers[currentIndex]);
                } catch (error) {
                    console.error("Error checking answer:", error);
                    alert("Vastuse Kontrollimisel läks midagi valesti. Proovi uuesti.");
                }
            }

            function displayFeedback(result) {
                const feedback = document.getElementById("feedback");
                feedback.classList.remove("hidden");

                if (result.isCorrect) {
                    feedback.innerHTML = `
                    <div class="bg-green-100 border-l-4 border-green-500 text-green-700 p-4 rounded">
                        <p class="font-bold">✓ Õige!</p>
                        <p>Hea töö! Su vastus oli õige.</p>
                    </div>
                `;
                } else {
                    feedback.innerHTML = `
                    <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded">
                        <p class="font-bold">✗ Vale vastus</p>
                        <p class="mt-2"><strong>Sinu vastus:</strong> ${result.answer}</p>
                        <p class="mt-1"><strong>Õige vastus:</strong> ${result.correctAnswer}</p>
                    </div>
                `;
                }
            }

            function previousCard() {
                if (currentIndex > 0) {
                    currentIndex--;
                    displayCard();
                }
            }

            function nextCard() {
                if (currentIndex < flashcards.length - 1) {
                    currentIndex++;
                    displayCard();
                }
            }

            document
                .getElementById("answer")
                .addEventListener("keypress", (e) => {
                    if (e.key === "Enter" && e.ctrlKey) {
                        submitAnswer();
                    }
                });

            init();
        </script>
    </body>
</html>
