<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>YFX0060 Õppija</title>
        <script src="https://cdn.tailwindcss.com"></script>
    </head>
    <body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
        <div class="container mx-auto px-4 py-8">
            <div class="max-w-3xl mx-auto">
                <!-- Header -->
                <div class="flex justify-between items-center mb-8">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-800">
                            ⚛️ YFX0060 Õppija ⚛️
                        </h1>
                        <p
                            id="session-info"
                            class="text-sm text-gray-600 mt-1"
                        ></p>
                    </div>
                    <div class="flex gap-2">
                        <button
                            id="new-ticket-btn"
                            onclick="rerollTicket()"
                            class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg transition duration-200 hidden"
                        >
                            Uus Pilet
                        </button>
                        <a
                            href="/"
                            class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition duration-200"
                        >
                            Tagasi
                        </a>
                    </div>
                </div>

                <!-- Progress Bar -->
                <div class="bg-white rounded-lg shadow-md p-4 mb-6">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm font-medium text-gray-600">
                            Küsimused
                        </span>
                        <span
                            class="text-sm font-medium text-gray-600"
                            id="progress-text"
                            >0/0</span
                        >
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-3">
                        <div
                            id="progress-bar"
                            class="bg-blue-500 h-3 rounded-full transition-all duration-300"
                            style="width: 0%"
                        ></div>
                    </div>
                </div>

                <!-- Flashcard -->
                <div class="bg-white rounded-2xl shadow-xl p-8 mb-6">
                    <div class="mb-6">
                        <h2 class="text-xl font-semibold text-gray-700 mb-4">
                            Küsimus:
                        </h2>
                        <p
                            id="question"
                            class="text-2xl text-gray-800 mb-6"
                        ></p>
                    </div>

                    <div class="mb-6">
                        <label
                            for="answer"
                            class="block text-lg font-semibold text-gray-700 mb-2"
                            >Sinu vastus:</label
                        >
                        <textarea
                            id="answer"
                            rows="4"
                            class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 transition duration-200"
                            placeholder="Kirjuta oma vastus siia..."
                        ></textarea>
                    </div>

                    <button
                        id="submit-btn"
                        onclick="submitAnswer()"
                        class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg transition duration-200 transform hover:scale-105 shadow-md"
                    >
                        Esita vastus
                    </button>

                    <!-- Feedback -->
                    <div id="feedback" class="mt-6 hidden"></div>
                </div>

                <!-- Navigation -->
                <div class="flex gap-4">
                    <button
                        id="prev-btn"
                        onclick="previousCard()"
                        class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                        ← Eelmine
                    </button>
                    <button
                        id="next-btn"
                        onclick="nextCard()"
                        class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                        Järgmine →
                    </button>
                </div>
            </div>
        </div>

        <script>
            let flashcards = [];
            let currentIndex = 0;
            let userAnswers = [];
            let sessionMode = "";
            let sessionVariant = "";
            let currentTicket = "";

            function init() {
                const stored = localStorage.getItem("flashcards");
                const storedIndex = localStorage.getItem("currentIndex");
                sessionMode = localStorage.getItem("sessionMode") || "";
                sessionVariant = localStorage.getItem("sessionVariant") || "";
                currentTicket = localStorage.getItem("currentTicket") || "";

                if (!stored) {
                    window.location.href = "/";
                    return;
                }

                flashcards = JSON.parse(stored);
                currentIndex = parseInt(storedIndex || "0");
                userAnswers = new Array(flashcards.length).fill(null);

                updateSessionInfo();
                displayCard();

                if (sessionMode === "random") {
                    document
                        .getElementById("new-ticket-btn")
                        .classList.remove("hidden");
                }
            }

            function updateSessionInfo() {
                const sessionInfo = document.getElementById("session-info");

                if (sessionMode === "variant") {
                    const card = flashcards[currentIndex];
                    sessionInfo.textContent = `Variant ${sessionVariant} | Pilet ${card.ticket}`;
                } else if (sessionMode === "random") {
                    sessionInfo.textContent = `Pilet ${currentTicket}`;
                }
            }

            async function rerollTicket() {
                if (sessionMode !== "random") return;

                const newTicketBtn = document.getElementById("new-ticket-btn");
                newTicketBtn.disabled = true;
                newTicketBtn.textContent = "Laadin...";

                try {
                    const url = `/api/cards?mode=random&excludeTicket=${currentTicket}`;
                    const response = await fetch(url);
                    const data = await response.json();

                    if (!data.cards || data.cards.length === 0) {
                        alert("Pole rohkem pileteid!");
                        return;
                    }

                    flashcards = data.cards;
                    currentIndex = 0;
                    userAnswers = new Array(flashcards.length).fill(null);
                    currentTicket = data.currentTicket;

                    localStorage.setItem(
                        "flashcards",
                        JSON.stringify(flashcards),
                    );
                    localStorage.setItem("currentIndex", "0");
                    localStorage.setItem("currentTicket", currentTicket);

                    displayCard();
                } catch (error) {
                    console.error("Error fetching new ticket:", error);
                    alert("Uue pileti laadimisel läks midagi valesti!");
                } finally {
                    newTicketBtn.disabled = false;
                    newTicketBtn.textContent = "Uus Pilet";
                }
            }

            function displayCard() {
                if (flashcards.length === 0) return;

                const card = flashcards[currentIndex];
                document.getElementById("question").textContent = card.question;
                document.getElementById("answer").value =
                    userAnswers[currentIndex]?.answer || "";
                document.getElementById("progress-text").textContent =
                    `${currentIndex + 1}/${flashcards.length}`;

                const progress = ((currentIndex + 1) / flashcards.length) * 100;
                document.getElementById("progress-bar").style.width =
                    `${progress}%`;

                document.getElementById("prev-btn").disabled =
                    currentIndex === 0;
                document.getElementById("next-btn").disabled =
                    currentIndex === flashcards.length - 1;

                const feedback = document.getElementById("feedback");
                if (userAnswers[currentIndex]) {
                    displayFeedback(userAnswers[currentIndex]);
                } else {
                    feedback.classList.add("hidden");
                }

                updateSessionInfo();
                localStorage.setItem("currentIndex", currentIndex.toString());
            }

            async function submitAnswer() {
                const answerText = document
                    .getElementById("answer")
                    .value.trim();

                if (!answerText) {
                    alert("Palun sisesta vastus!");
                    return;
                }

                const card = flashcards[currentIndex];
                const submitBtn = document.getElementById("submit-btn");
                submitBtn.disabled = true;
                submitBtn.textContent = "Kontrollin...";

                try {
                    const response = await fetch("/api/check-answer", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            cardId: card.id,
                            answer: answerText,
                        }),
                    });

                    const result = await response.json();
                    userAnswers[currentIndex] = {
                        answer: answerText,
                        state: result.state,
                        description: result.description,
                        correctAnswer: result.correctAnswer,
                    };

                    displayFeedback(userAnswers[currentIndex]);
                } catch (error) {
                    console.error("Error checking answer:", error);
                    alert(
                        "Vastuse kontrollimisel läks midagi valesti. Proovi uuesti.",
                    );
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = "Esita Vastus";
                }
            }

            function displayFeedback(result) {
                const feedback = document.getElementById("feedback");
                feedback.classList.remove("hidden");

                if (result.state === "correct") {
                    feedback.innerHTML = `
                    <div class="bg-green-100 border-l-4 border-green-500 text-green-700 p-4 rounded">
                        <p class="font-bold">✓ Õige!</p>
                        <p class="mt-2">${result.description}</p>
                    </div>
                `;
                } else if (result.state === "partially_correct") {
                    feedback.innerHTML = `
                    <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded">
                        <p class="font-bold">⚠ Pooleldi õige</p>
                        <p class="mt-2">${result.description}</p>
                        <p class="mt-2"><strong>Sinu vastus:</strong> ${result.answer}</p>
                        <p class="mt-1"><strong>Õige vastus:</strong> ${result.correctAnswer}</p>
                    </div>
                `;
                } else {
                    feedback.innerHTML = `
                    <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded">
                        <p class="font-bold">✗ Vale</p>
                        <p class="mt-2">${result.description}</p>
                        <p class="mt-2"><strong>Sinu vastus:</strong> ${result.answer}</p>
                        <p class="mt-1"><strong>Õige vastus:</strong> ${result.correctAnswer}</p>
                    </div>
                `;
                }
            }

            function previousCard() {
                if (currentIndex > 0) {
                    currentIndex--;
                    displayCard();
                }
            }

            function nextCard() {
                if (currentIndex < flashcards.length - 1) {
                    currentIndex++;
                    displayCard();
                }
            }

            document
                .getElementById("answer")
                .addEventListener("keypress", (e) => {
                    if (e.key === "Enter" && e.ctrlKey) {
                        submitAnswer();
                    }
                });

            init();
        </script>
    </body>
</html>
